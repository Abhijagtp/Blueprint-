{% extends 'dashboard.html' %}
{% block content %}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Homepage</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #f5f6fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }

    /* Search Bar */
    .search-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      gap: 15px;
    }

    .search-bar .input-group {
      flex-grow: 1;
      display: flex;
      align-items: center;
      max-width: calc(100% - 60px);
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }

    .search-bar input {
      border: none;
      outline: none;
      font-size: 14px;
      padding: 8px 12px;
      width: 100%;
      background: transparent;
      color: #1f2937;
    }

    .search-bar input::placeholder {
      color: #9ca3af;
    }

    .search-bar .btn-success {
      border: none;
      border-radius: 0 8px 8px 0;
      padding: 8px 12px;
      background-color: #198754;
      transition: background-color 0.2s ease;
    }

    .search-bar .btn-success:hover,
    .search-bar input:focus+.btn-success {
      background-color: #157347;
    }

    .search-bar .profile-img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    /* Email List */
    .email-list {
      max-width: 400px;
      margin: auto;
      padding: 10px;
    }

    .email-card {
      border-radius: 12px;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
      background: #fff;
    }

    .email-card:hover {
      
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .email-card.selected {
      background: #e6f0ff; /* Light blue background for selected email */
    }

    .email-card .card-body {
      display: flex;
      align-items: flex-start;
      padding: 12px;
    }

    .profile-img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }

    .email-card h6 {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin: 0;
    }

    .email-card .time {
      font-size: 12px;
      color: #6b7280;
    }

    .email-card .email-preview {
      font-size: 13px;
      color: #6b7280;
      margin: 4px 0 0;
    }

    .email-card .more-options {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      color: #9ca3af;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .email-card .more-options:hover {
      background: #cad4e7;
      z-index:999;
    }

    .starred {
      color: #ffd700;
    }

    /* Floating Button */
    .floating-button {
      position: fixed;
      bottom: 40px;
      right: 40px;
      background: #1a73e8;
      color: white;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s;
      border: none;
    }

    .floating-button:hover {
      transform: scale(1.1);
    }

    /* Compose and Reply Containers */
    .compose-container {
      position: fixed;
      bottom: -100%;
      right: 20px;
      width: 480px;
      max-height: 80vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      transition: bottom 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }

    .compose-container.active {
      bottom: 20px;
    }

    .compose-header {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 12px 12px 0 0;
      font-size: 14px;
      color: #1f2937;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .compose-header h6 {
      margin: 0;
    }

    .compose-header .btn {
      padding: 0;
      margin: 0;
      background: transparent;
      border: none;
    }

    .compose-container .form-control {
      border: none;
      box-shadow: none;
      font-size: 14px;
      padding: 10px 15px;
    }

    .compose-container .email-section {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 15px;
    }

    .compose-container textarea.form-control {
      border-bottom: none;
      min-height: 180px;
      resize: vertical;
    }

    .compose-footer {
      padding: 10px 15px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .compose-footer .btn {
      padding: 0;
      margin: 0;
      background: transparent;
      border: none;
    }

    .compose-footer .btn-dark-blue {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 6px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .compose-footer .btn-dark-blue:hover {
      background: #1557b0;
    }

    .compose-container .email-field {
      display: flex;
      align-items: center;
      padding: 8px 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    .compose-container .email-field label {
      width: 60px;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
    }

    .compose-container .email-field input {
      flex-grow: 1;
      padding: 6px 0;
      font-size: 14px;
      background: transparent;
    }

    .compose-container .email-field input[readonly] {
      color: #6b7280;
      cursor: default;
    }

    .compose-container .email-body {
      min-height: 200px;
      padding: 15px;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Attachment Preview */
    .attachment-preview {
      padding: 10px 15px;
      background: #f8f9fa;
      max-height: 150px;
      overflow-y: auto;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      padding: 5px 10px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 5px;
    }

    .attachment-item i {
      margin-right: 8px;
      color: #1a73e8;
    }

    .attachment-item span {
      flex-grow: 1;
      font-size: 13px;
      color: #1f2937;
    }

    .attachment-item .remove-attachment {
      background: transparent;
      border: none;
      color: #dc3545;
      font-size: 14px;
      padding: 0 5px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .attachment-item .remove-attachment:hover {
      color: #b02a37;
    }
    .attachment-size-info {
  background: #f8f9fa;
  border-top: 1px solid #e5e7eb;
}

.attachment-item .size {
  color: #6b7280;
  margin-left: 10px;
}
    /* Action Buttons */
    .compose-footer .action-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .compose-footer .attachment-btn {
      cursor: pointer;
    }

    /* Email Content Section */
    .email-content-section {
  padding: 20px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  position: relative;
}

.email-header {
  display: flex;
  align-items: flex-start;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 10px;
  margin-bottom: 15px;
  position: relative;
}

.email-header .time {
  position: absolute;
  top: -15px;
  right: 0;
  font-size: 12px;
  color: #6b7280;
  padding: 5px 10px; /* Added padding for spacing */
  background: #fff; /* Optional: slight background to distinguish from icons */
  border-radius: 4px;
  margin-right: 10px; /* Space from the right edge or icons */
}

.email-header .profile-img {
  margin-right: 10px;
}

.email-header h6 {
  margin: 0;
  font-size: 16px;
  color: #1f2937;
}

.email-header small {
  color: #6b7280;
  font-size: 12px;
}

.email-header .header-right {
  display: flex;
  align-items: center;
  gap: 8px; /* Increased gap between icons for better spacing */
  margin-left: auto;
  padding-top: 5px; /* Align icons slightly below the time */
}

.email-header .action-btn {
  font-size: 16px;
  color: #6b7280;
  padding: 5px;
  background: transparent;
  border: none;
  transition: color 0.2s;
  margin-right: 2px; /* Small margin between individual buttons */
}

.email-header .action-btn:hover {
  color: #1a73e8;
}

/* Ensure the dropdown doesn't interfere with spacing */
.email-header .dropdown-menu {
  margin-top: 5px; /* Adjust dropdown position if needed */
  
}

    .email-body p {
      font-size: 14px;
      color: #4b5563;
      line-height: 1.5;
    }

    .attachment-section {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .attachment-section h6 {
      font-size: 14px;
      color: #6b7280;
      margin: 0 0 5px;
    }

    .attachment-section a {
      color: #1a73e8;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .attachment-section a:hover {
      text-decoration: underline;
    }

    .attachment-section a i {
      margin-right: 5px;
    }
    .replies-section {
  margin-top: 20px;
  padding: 20px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.replies-section h5 {
  font-size: 16px;
  font-weight: 500;
  color: #1f2937;
  margin-bottom: 15px;
}

.reply-card {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  background: #fafafa;
  transition: background 0.2s ease;
}

.reply-card:last-child {
  margin-bottom: 0;
}

.reply-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.reply-header .profile-img {
  width: 32px;
  height: 32px;
  margin-right: 10px;
}

.reply-header h6 {
  font-size: 14px;
  font-weight: 500;
  color: #1f2937;
  margin: 0;
}

.reply-header small {
  font-size: 12px;
  color: #6b7280;
  display: block;
}

.reply-body p {
  font-size: 14px;
  color: #4b5563;
  line-height: 1.5;
  margin: 0;
}

.reply-body .attachment-section {
  margin-top: 10px;
}


    /* Tabs Container */
    .tabs-container {
      width: 100%;
      margin-bottom: 20px;
      padding: 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .tab-btn {
      position: relative;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-right: 8px;
    }

    .tab-btn:hover {
      color: #1a73e8;
      border-color: #1a73e8;
    }

    .tab-btn.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
      box-shadow: 0 2px 6px rgba(26, 115, 232, 0.3);
    }

    .tab-btn.active:hover {
      background: #1557b0;
      border-color: #1557b0;
    }

    .tab-btn .badge {
      margin-left: 6px;
      font-size: 11px;
      padding: 2px 6px;
      background: #e5e7eb;
      color: #4b5563;
      border-radius: 10px;
      vertical-align: middle;
      transition: all 0.3s ease;
    }

    .tab-btn.active .badge {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    /* Options Dropdown */
    .options-dropdown .btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      color: #6b7280;
      transition: all 0.3s ease;
    }

    .options-dropdown .btn:hover {
      border-color: #1a73e8;
      color: #1a73e8;
    }

    .options-dropdown .dropdown-menu {
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 6px 0;
    }

    .options-dropdown .dropdown-item {
      padding: 6px 12px;
      font-size: 14px;
      color: #4b5563;
      transition: all 0.2s ease;
      border-radius: 8px;
      margin: 2px 4px;
    }

    .options-dropdown .dropdown-item:hover {
      background: #f1f5f9;
      color: #1a73e8;
    }

    .options-dropdown .dropdown-item i {
      margin-right: 8px;
      width: 16px;
    }
    /* Load More Button Styles */
.load-more-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 24px;
  font-size: 16px;
  font-weight: 500;
  color: #ffffff;
  background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); /* Gradient background for a modern look */
  border: none;
  border-radius: 8px; /* Rounded corners */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
  cursor: pointer;
  transition: all 0.3s ease; /* Smooth transitions for hover and loading states */
  position: relative;
  overflow: hidden;
}

/* Hover Effect */
.load-more-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); /* Darker gradient on hover */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Slightly larger shadow on hover */
  transform: translateY(-2px); /* Slight lift effect */
}

/* Disabled State */
.load-more-btn:disabled {
  background: #d1d5db; /* Gray background for disabled state */
  color: #6b7280; /* Muted text color */
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

/* Loading State */
.load-more-btn.loading::after {
  content: '';
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #ffffff;
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 8px;
}

/* Loading Animation */
@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Ripple Effect on Click */
.load-more-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s ease, height 0.6s ease;
}

.load-more-btn:active::before {
  width: 200px;
  height: 200px;
  opacity: 0;
}

/* Container for Centering */
#loadMoreContainer {
  margin-top: 20px;
  text-align: center;
}
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-4">
        <div class="search-bar">
          <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search emails" />
            <button class="btn btn-success" id="searchButton"><i class="ri-search-line"></i></button>
          </div>
          <img src="{{ user.userprofile.profile_image.url|default:'/static/images/default_profile.png' }}" alt="Profile"
            class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
        </div>

        <div class="tabs-container">
          <div class="d-flex gap-2">
            <button class="tab-btn active" id="allMailsTab" data-filter="all">All Mails
              <span class="badge">{{ unread_count }}</span>
            </button>
            <button class="tab-btn" id="sentTab" data-filter="sent">Sent</button>
            <button class="tab-btn" id="archiveTab" data-filter="archive">Archive</button>
          </div>
          <div class="options-dropdown dropdown">
            <button class="btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="ri-more-2-line"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="starredTab" data-filter="starred"><i
                    class="ri-star-line"></i>Starred</a></li>
              <li><a class="dropdown-item" href="#" id="unreadTab" data-filter="unread"><i
                    class="ri-mail-unread-line"></i>Unread</a></li>
            </ul>
          </div>
        </div>

        <div class="email-list" id="emailList">
          {% for email in emails %}
          {% if email.sender.email != user.email or filter == 'sent' %}
          <div class="card email-card" data-email-id="{{ email.id }}" data-read="{{ email.read|yesno:'true,false' }}"
            data-starred="{{ email.starred|yesno:'true,false' }}"
            data-archived="{{ email.is_archived|yesno:'true,false' }}">
            <div class="card-body d-flex align-items-start">
              <img src="{{ email.sender.userprofile.profile_image.url|default:'/static/images/default_profile.png' }}"
                alt="User" class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
              <div class="ms-3 flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">{{ email.sender.first_name }} {{ email.sender.last_name }}</h6>
                  <span class="time">{{ email.timestamp|date:"H:i" }}</span>
                </div>
                <p class="text-muted mb-1">
                  <strong>{{ email.subject }}</strong>
                  {% if not email.read and email.user == user %}
                  <span class="badge bg-success ms-2">New</span>
                  {% endif %}
                  {% if email.starred %}
                  <i class="ri-star-line starred ms-2"></i>
                  {% endif %}
                </p>
                <p class="email-preview">{{ email.decrypt_body|truncatechars:50|safe }}</p>
              </div>
              <div class="dropdown">
                <button class="btn btn-light more-options" data-bs-toggle="dropdown">
                  <i class="ri-more-2-line"></i>
                </button>
                <ul class="dropdown-menu ">
                  {% if email.is_archived %}
                  <li><a class="dropdown-item" href="#" onclick="unarchiveEmail({{ email.id }})"><i
                        class="ri-inbox-unarchive-line"></i> Unarchive</a></li>
                  {% else %}
                  <li><a class="dropdown-item" href="#" onclick="archiveEmail({{ email.id }})"><i
                        class="ri-archive-line"></i> Archive</a></li>
                  {% endif %}
                  <li><a class="dropdown-item" href="#" onclick="starEmail({{ email.id }})"><i class="ri-star-line"></i>
                      {% if email.starred %}Unstar{% else %}Star{% endif %}</a></li>
                  <li><a class="dropdown-item" href="#" onclick="deleteEmail({{ email.id }})"><i
                        class="ri-delete-bin-line"></i> Delete</a></li>
                </ul>
              </div>
            </div>
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <div class="text-center mt-3" id="loadMoreContainer">
          <!-- Load More button will be added here dynamically -->
        </div>
      </div>

      <div class="col-md-8">
        <div class="email-content-section"></div>
        <div class="replies-section">
          <h5 class="mb-3">Conversation</h5>
          <div id="repliesContainer" class="d-flex flex-column gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <button class="floating-button" id="composeBtn"><i class="ri-quill-pen-line"></i></button>

 <!-- Compose Container -->
<div class="compose-container" id="composeContainer">
  <div class="compose-header d-flex justify-content-between align-items-center">
    <h6 class="mb-0">New Message</h6>
    <button class="btn btn-sm p-0" id="closeCompose"><i class="ri-close-line text-muted"></i></button>
  </div>
  <form id="composeForm" method="post" action="{% url 'send_email' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="email-section">
      <div class="email-field">
        <label>From:</label>
        <input type="email" class="form-control" name="from" value="{{ user.email }}" readonly>
      </div>
      <div class="email-field">
        <label>To:</label>
        <input type="email" class="form-control" name="recipient" placeholder="Recipient's email" required>
      </div>
      <div class="email-field">
        <label>Subject:</label>
        <input type="text" class="form-control" name="subject" placeholder="Subject">
      </div>
    </div>
    <textarea class="form-control email-body" name="body" placeholder="Compose email..."></textarea>
    <div class="attachment-preview" id="composeAttachmentPreview"></div>
    <div class="attachment-size-info text-muted small px-3 py-1" id="composeAttachmentSizeInfo">
      Total size: 0 MB / 100 MB
    </div>
    <div class="compose-footer d-flex justify-content-between align-items-center">
      <div class="action-buttons">
        <button type="button" class="btn p-0" id="discardCompose"><i class="ri-delete-bin-line text-muted"></i></button>
        <label class="btn p-0 ms-2 attachment-btn">
          <i class="ri-upload-2-line text-muted"></i>
          <input type="file" name="attachments" id="composeAttachment" style="display: none;" multiple>
        </label>
      </div>
      <button type="submit" class="btn btn-dark-blue" id="composeSubmitBtn">Send</button>
    </div>
  </form>
</div>

<!-- Reply Container -->
<div class="compose-container" id="replyContainer">
  <div class="compose-header d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Reply</h6>
    <button class="btn btn-sm p-0" id="closeReply"><i class="ri-close-line text-muted"></i></button>
  </div>
  <form id="replyForm" method="post" action="{% url 'reply_email' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="email_id" id="emailId">
    <div class="email-section">
      <div class="email-field">
        <label>From:</label>
        <input type="email" class="form-control" name="from" value="{{ user.email }}" readonly>
      </div>
      <div class="email-field">
        <label>To:</label>
        <input type="email" class="form-control" name="recipient" id="replyRecipient" readonly>
      </div>
    </div>
    <textarea class="form-control email-body" name="reply_body" placeholder="Write your reply..."></textarea>
    <div class="attachment-preview" id="replyAttachmentPreview"></div>
    <div class="attachment-size-info text-muted small px-3 py-1" id="replyAttachmentSizeInfo">
      Total size: 0 MB / 100 MB
    </div>
    <div class="compose-footer d-flex justify-content-between align-items-center">
      <div class="action-buttons">
        <button type="button" class="btn p-0" id="discardReply"><i class="ri-delete-bin-line text-muted"></i></button>
        <label class="btn p-0 ms-2 attachment-btn">
          <i class="ri-upload-2-line text-muted"></i>
          <input type="file" name="attachments" id="replyAttachment" style="display: none;" multiple>
        </label>
      </div>
      <button type="submit" class="btn btn-dark-blue" id="replySubmitBtn">Send</button>
    </div>
  </form>
</div>
</body>
<script>
  // Global variables
  const state = {
    emailList: null,
    emailContentSection: null,
    repliesContainer: null,
    currentFilter: 'all',
    currentPage: 1, // Track the current page
    emailsPerPage: 10, // Number of emails per page
    emails: [], // Store all emails fetched from the server
    hasNext: true // Track if there are more emails to load
  };
  
  // Utility Functions
  const utils = {
    getCsrfToken() {
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      return csrfInput ? csrfInput.value : '{{ csrf_token }}';
    },
  
    debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    },
  
    formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || 'N/A';
    },
  
    formatDateTime(timestamp) {
      return new Date(timestamp).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) || 'N/A';
    }
  };
  
  // Email Fetching and Rendering
  const emailActions = {
    getEmailUrl(filter) {
      const urls = {
        'sent': '{% url "sent_emails" %}',
        'archive': '{% url "archive_emails" %}',
        'starred': '{% url "starred_emails" %}',
        'unread': '{% url "unread_emails" %}',
        'all': '{% url "inbox" %}'
      };
      return urls[filter] || '{% url "inbox" %}';
    },
  
    filterEmails(emails, filter) {
      const userEmail = '{{ user.email }}';
      if (filter === 'all') return emails.filter(e => e.sender !== userEmail && !e.archived && !e.deleted);
      if (filter === 'sent') return emails.filter(e => e.sender === userEmail && !e.archived && !e.deleted);
      if (filter === 'archive') return emails.filter(e => e.archived && !e.deleted);
      if (filter === 'starred') return emails.filter(e => e.starred && !e.archived && !e.deleted);
      if (filter === 'unread') return emails.filter(e => !e.read && e.sender !== userEmail && !e.archived && !e.deleted);
      return emails;
    },
  
    renderEmails(emailsToRender, append = false) {
      if (!append) {
        state.emailList.innerHTML = ''; // Clear the email list if not appending
      }
  
      const emailHtml = emailsToRender.length ? emailsToRender.map(email => `
        <div class="card email-card" data-email-id="${email.id}" data-read="${email.read}" data-starred="${email.starred}" data-archived="${email.archived}">
          <div class="card-body d-flex align-items-start">
            <img src="${email.sender_profile_image || '/static/images/default_profile.png'}" alt="User" class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
            <div class="ms-3 flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${email.username || email.sender}</h6>
                <span class="time">${utils.formatTime(email.timestamp)}</span>
              </div>
              <p class="text-muted mb-1">
                <strong>${email.subject}</strong>
                ${!email.read && email.sender !== '{{ user.email }}' ? '<span class="badge bg-success ms-2">New</span>' : ''}
                ${email.starred ? '<i class="ri-star-line starred ms-2"></i>' : ''}
              </p>
              <p class="email-preview">${email.body.substring(0, 50)}${email.body.length > 50 ? '...' : ''}</p>
            </div>
            <div class="dropdown">
              <button class="btn btn-light more-options" data-bs-toggle="dropdown"><i class="ri-more-2-line"></i></button>
              <ul class="dropdown-menu">
                ${email.archived ? 
                  `<li><a class="dropdown-item archive-action" href="#" data-email-id="${email.id}" data-action="unarchive"><i class="ri-inbox-unarchive-line"></i> Unarchive</a></li>` : 
                  `<li><a class="dropdown-item archive-action" href="#" data-email-id="${email.id}" data-action="archive"><i class="ri-archive-line"></i> Archive</a></li>`}
                <li><a class="dropdown-item star-action" href="#" data-email-id="${email.id}"><i class="ri-star-line"></i> ${email.starred ? 'Unstar' : 'Star'}</a></li>
                <li><a class="dropdown-item delete-action" href="#" data-email-id="${email.id}"><i class="ri-delete-bin-line"></i> Delete</a></li>
              </ul>
            </div>
          </div>
        </div>
      `).join('') : '<p>No emails found</p>';
  
      if (append) {
        state.emailList.insertAdjacentHTML('beforeend', emailHtml);
      } else {
        state.emailList.innerHTML = emailHtml;
      }
  
      this.attachEmailCardListeners();
  
      // Update Load More button visibility
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      const displayedEmailsCount = document.querySelectorAll('.email-card').length;
      state.hasNext = displayedEmailsCount < state.emails.length;
  
      if (state.hasNext) {
        loadMoreContainer.innerHTML = '<button class="load-more-btn" id="loadMoreBtn">Load More</button>';
        document.getElementById('loadMoreBtn').addEventListener('click', () => this.loadMoreEmails());
      } else {
        loadMoreContainer.innerHTML = '';
      }
  
      if (emailsToRender.length && !append) {
        this.loadEmail(emailsToRender[0].id);
      } else if (!document.querySelectorAll('.email-card').length) {
        state.emailContentSection.innerHTML = '<p>No emails selected</p>';
        state.repliesContainer.innerHTML = '';
      }
  
      if (state.currentFilter === 'all') {
        document.querySelector('#allMailsTab .badge').textContent = state.emails.filter(e => !e.read).length;
      }
    },
  
    loadEmails(filter) {
      state.currentFilter = filter;
      state.currentPage = 1; // Reset to first page
      fetch(this.getEmailUrl(filter), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(emails => {
          state.emails = this.filterEmails(emails, filter); // Store all emails
          const startIndex = (state.currentPage - 1) * state.emailsPerPage;
          const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
          this.renderEmails(emailsToRender);
        })
        .catch(error => {
          console.error('Error loading emails:', error);
          state.emailList.innerHTML = `<p>Error loading emails: ${error.message}</p>`;
          document.getElementById('loadMoreContainer').innerHTML = '';
        });
    },
  
    loadMoreEmails() {
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      loadMoreBtn.classList.add('loading');
      loadMoreBtn.disabled = true;
  
      state.currentPage += 1;
      const startIndex = (state.currentPage - 1) * state.emailsPerPage;
      const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
      this.renderEmails(emailsToRender, true);
  
      loadMoreBtn.classList.remove('loading');
      loadMoreBtn.disabled = false;
    },
  
    loadEmail(emailId) {
      fetch(`/emails/${emailId}/`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(data => {
          state.emailContentSection.innerHTML = `
            <div class="email-header">
              <span class="time">${utils.formatTime(data.timestamp)}</span>
              <img src="${data.sender_profile_image || '/static/images/default_profile.png'}" alt="User" class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
              <div class="ms-3 flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6>${data.username || data.sender}</h6>
                  </div>
                </div>
                <p class="text-muted mt-1"><strong>${data.subject}</strong></p>
              </div>
              <div class="header-right">
                <button class="action-btn reply-btn" data-email-id="${emailId}"><i class="ri-reply-line"></i></button>
                ${data.archived ? 
                  `<button class="action-btn unarchive-btn" data-email-id="${emailId}"><i class="ri-inbox-unarchive-line"></i></button>` : 
                  `<button class="action-btn archive-btn" data-email-id="${emailId}"><i class="ri-archive-line"></i></button>`}
                <button class="action-btn star-btn ${data.starred ? 'starred' : ''}" data-email-id="${emailId}"><i class="ri-star-line"></i></button>
                <button class="action-btn ${data.read ? 'mark-as-unread-btn' : 'mark-as-read-btn'}" data-email-id="${emailId}"><i class="${data.read ? 'ri-mail-unread-line' : 'ri-mail-read-line'}"></i></button>
                <div class="dropdown">
                  <button class="action-btn" data-bs-toggle="dropdown" aria-expanded="false"><i class="ri-more-2-line"></i></button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    ${data.archived ? 
                      `<li><a class="dropdown-item archive-action" href="#" data-email-id="${emailId}" data-action="unarchive"><i class="ri-inbox-unarchive-line"></i> Unarchive</a></li>` : 
                      `<li><a class="dropdown-item archive-action" href="#" data-email-id="${emailId}" data-action="archive"><i class="ri-archive-line"></i> Archive</a></li>`}
                    <li><a class="dropdown-item star-action" href="#" data-email-id="${emailId}"><i class="ri-star-line"></i> ${data.starred ? 'Unstar' : 'Star'}</a></li>
                    <li><a class="dropdown-item delete-action" href="#" data-email-id="${emailId}"><i class="ri-delete-bin-line"></i> Delete</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="email-body mt-3">
              <p>${data.body}</p>
              ${data.attachments && data.attachments.length ? `
                <div class="attachment-section">
                  <h6>Attachments</h6>
                  ${data.attachments.map((url, index) => `
                    <a href="${url}" target="_blank"><i class="ri-attachment-line"></i> ${url.split('/').pop()} <span>${index + 1}</span></a>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `;
          this.attachEmailContentListeners();
  
          document.querySelectorAll('.email-card').forEach(card => {
            card.classList.remove('selected');
            if (card.getAttribute('data-email-id') === emailId) {
              card.classList.add('selected');
            }
          });
  
          this.loadReplies(emailId);
        })
        .catch(error => {
          console.error('Error loading email:', error);
          state.emailContentSection.innerHTML = `<p>Error loading email: ${error.message}</p>`;
          state.repliesContainer.innerHTML = '';
        });
    },
  
    loadReplies(emailId) {
      fetch(`/emails/${emailId}/replies/`)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then(replies => {
          state.repliesContainer.innerHTML = replies.length ? replies.map(reply => `
            <div class="reply-card">
              <div class="reply-header d-flex align-items-center">
                <img src="${reply.sender_profile_image || '/static/images/default_profile.png'}" alt="User" class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
                <div class="ms-3 flex-grow-1">
                  <h6 class="mb-0">${reply.username}</h6>
                  <small class="text-muted">${utils.formatDateTime(reply.timestamp)}</small>
                </div>
              </div>
              <div class="reply-body mt-2">
                <p>${reply.body}</p>
                ${reply.attachments && reply.attachments.length ? `
                  <div class="attachment-section">
                    <h6>Attachments</h6>
                    ${reply.attachments.map((url, index) => `
                      <a href="${url}" target="_blank"><i class="ri-attachment-line"></i> ${url.split('/').pop()} <span>${index + 1}</span></a>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('') : '<p class="text-muted">No replies yet.</p>';
        })
        .catch(error => {
          console.error('Error loading replies:', error);
          state.repliesContainer.innerHTML = `<p class="text-muted">Error loading replies: ${error.message}</p>`;
        });
    },
  
    attachEmailCardListeners() {
      document.querySelectorAll('.email-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (e.target.closest('.dropdown')) return;
          const emailId = card.getAttribute('data-email-id');
          this.loadEmail(emailId);
        });
      });
  
      document.querySelectorAll('.archive-action').forEach(action => {
        action.addEventListener('click', (e) => {
          e.preventDefault();
          const emailId = action.getAttribute('data-email-id');
          action.getAttribute('data-action') === 'archive' ? this.archiveEmail(emailId) : this.unarchiveEmail(emailId);
        });
      });
  
      document.querySelectorAll('.star-action').forEach(action => {
        action.addEventListener('click', (e) => {
          e.preventDefault();
          this.starEmail(action.getAttribute('data-email-id'));
        });
      });
  
      document.querySelectorAll('.delete-action').forEach(action => {
        action.addEventListener('click', (e) => {
          e.preventDefault();
          this.deleteEmail(action.getAttribute('data-email-id'));
        });
      });
    },
  
    attachEmailContentListeners() {
      const stopPropagation = (e) => e.stopPropagation();
      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', stopPropagation);
        btn.addEventListener('click', () => compose.openReplyContainer(btn.getAttribute('data-email-id')));
      });
  
      document.querySelectorAll('.archive-btn, .unarchive-btn, .archive-action').forEach(btn => {
        btn.addEventListener('click', stopPropagation);
        btn.addEventListener('click', () => {
          const emailId = btn.getAttribute('data-email-id');
          (btn.classList.contains('archive-btn') || btn.getAttribute('data-action') === 'archive') ? 
            this.archiveEmail(emailId) : this.unarchiveEmail(emailId);
        });
      });
  
      document.querySelectorAll('.star-btn, .star-action').forEach(btn => {
        btn.addEventListener('click', stopPropagation);
        btn.addEventListener('click', () => this.starEmail(btn.getAttribute('data-email-id')));
      });
  
      document.querySelectorAll('.mark-as-read-btn').forEach(btn => {
        btn.addEventListener('click', stopPropagation);
        btn.addEventListener('click', () => this.markAsRead(btn.getAttribute('data-email-id')));
      });
  
      document.querySelectorAll('.mark-as-unread-btn').forEach(btn => {
        btn.addEventListener('click', stopPropagation);
        btn.addEventListener('click', () => this.markAsUnread(btn.getAttribute('data-email-id')));
      });
  
      document.querySelectorAll('.delete-action').forEach(action => {
        action.addEventListener('click', stopPropagation);
        action.addEventListener('click', () => this.deleteEmail(action.getAttribute('data-email-id')));
      });
    },
  
    archiveEmail(emailId) {
      this.performAction('{% url "archive_email" 0 %}'.replace('0', emailId), () => {
        if (state.currentFilter !== 'archive') {
          state.emailContentSection.innerHTML = '<p>No emails selected</p>';
          state.repliesContainer.innerHTML = '';
        } else {
          this.loadEmail(emailId);
        }
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      });
    },
  
    unarchiveEmail(emailId) {
      this.performAction('{% url "unarchive_email" 0 %}'.replace('0', emailId), () => {
        if (state.currentFilter === 'archive') {
          state.emailContentSection.innerHTML = '<p>No emails selected</p>';
          state.repliesContainer.innerHTML = '';
        } else {
          this.loadEmail(emailId);
        }
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      });
    },
  
    starEmail(emailId) {
      this.performAction('{% url "star_email" 0 %}'.replace('0', emailId), () => {
        this.loadEmail(emailId);
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      }, { body: JSON.stringify({ action: 'toggle' }) });
    },
  
    markAsRead(emailId) {
      this.performAction('{% url "mark_as_read" 0 %}'.replace('0', emailId), () => {
        this.loadEmail(emailId);
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      });
    },
  
    markAsUnread(emailId) {
      this.performAction('{% url "mark_as_unread" 0 %}'.replace('0', emailId), () => {
        this.loadEmail(emailId);
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      });
    },
  
    deleteEmail(emailId) {
      if (!confirm('Are you sure you want to delete this email?')) return;
      this.performAction('{% url "delete_email" 0 %}'.replace('0', emailId), () => {
        state.emailContentSection.innerHTML = '<p>No emails selected</p>';
        state.repliesContainer.innerHTML = '';
        state.currentPage = 1; // Reset pagination
        this.loadEmails(state.currentFilter);
      });
    },
  
    performAction(url, callback, additionalOptions = {}) {
      fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': utils.getCsrfToken(), 'Content-Type': 'application/json' },
        ...additionalOptions
      })
        .then(response => {
          if (!response.ok) return response.text().then(text => { throw new Error(`HTTP ${response.status}: ${text}`); });
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            callback();
          } else {
            alert(data.message || 'Action failed');
          }
        })
        .catch(error => {
          console.error(`Error performing action:`, error);
          alert(`Error: ${error.message}`);
        });
    }
  };
  
// Compose and Reply Handling
const compose = {
  MAX_TOTAL_SIZE: 100 * 1024 * 1024, // 100MB in bytes
  composeFiles: [], // Store files for the Compose form
  replyFiles: [], // Store files for the Reply form

  // Function to update the attachment preview
  updateAttachmentPreview(input, previewContainer, sizeInfoContainer, fileList) {
    const newFiles = Array.from(input.files);

    // Add new files to the file list without clearing it
    newFiles.forEach(file => {
      if (!fileList.some(f => f.name === file.name && f.size === file.size)) {
        fileList.push(file); // Add only unique files
      }
    });

    const totalSize = fileList.reduce((sum, file) => sum + file.size, 0);
    const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);

    // Check if the total size exceeds the limit
    if (totalSize > this.MAX_TOTAL_SIZE) {
      alert('Total attachment size exceeds 100MB. Please remove some files.');
      fileList.length = 0; // Clear the file list
      input.value = ''; // Clear the input
      previewContainer.innerHTML = '';
      sizeInfoContainer.textContent = 'Total size: 0 MB / 100 MB';
      return;
    }

    // Update the input.files to reflect the current fileList
    const dt = new DataTransfer();
    fileList.forEach(file => dt.items.add(file));
    input.files = dt.files;

    // Render the preview
    previewContainer.innerHTML = ''; // Clear the preview
    fileList.forEach((file, index) => {
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      const fileItem = document.createElement('div');
      fileItem.className = 'attachment-item';
      fileItem.innerHTML = `
        <i class="ri-attachment-line"></i>
        <span>${file.name}</span>
        <span class="size">(${fileSizeMB} MB)</span>
        <button type="button" class="remove-attachment" data-index="${index}">
          <i class="ri-close-line"></i>
        </button>
      `;
      previewContainer.appendChild(fileItem);

      // Add event listener for removing files
      fileItem.querySelector('.remove-attachment').addEventListener('click', () => {
        const indexToRemove = parseInt(fileItem.querySelector('.remove-attachment').getAttribute('data-index'), 10);
        fileList.splice(indexToRemove, 1); // Remove the file from the fileList

        // Update the input.files to reflect the updated fileList
        const dt = new DataTransfer();
        fileList.forEach(f => dt.items.add(f));
        input.files = dt.files;

        // Re-render the preview with the updated fileList
        this.updateAttachmentPreview(input, previewContainer, sizeInfoContainer, fileList);
      });
    });

    // Update the total size info
    sizeInfoContainer.textContent = `Total size: ${totalSizeMB} MB / 100 MB`;
  },

  // Function to open the reply container
  openReplyContainer(emailId) {
    const emailIdInput = document.getElementById('emailId');
    const replyContainer = document.getElementById('replyContainer');
    emailIdInput.value = emailId;
    fetch(`/emails/${emailId}/`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('replyRecipient').value = data.sender;
        replyContainer.classList.add('active');
      })
      .catch(error => console.error('Error fetching email:', error));
  },

  // Function to reset the form
  resetForm(container, form, preview, input, sizeInfo, fileList) {
    container.classList.remove('active');
    form.reset();
    preview.innerHTML = '';
    input.value = '';
    fileList.length = 0; // Clear the file list
    sizeInfo.textContent = 'Total size: 0 MB / 100 MB';
  },

  // Function to submit the form
  submitForm(form, container, preview, input, sizeInfo, successCallback, fileList) {
    const formData = new FormData(form);
    const files = input.files;
    const totalSize = Array.from(files).reduce((sum, file) => sum + file.size, 0);

    if (totalSize > this.MAX_TOTAL_SIZE) {
      alert('Total attachment size exceeds 100MB. Please remove some files.');
      return;
    }

    for (let i = 0; i < files.length; i++) {
      formData.append('attachments', files[i]);
    }

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': utils.getCsrfToken() }
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          this.resetForm(container, form, preview, input, sizeInfo, fileList);
          successCallback();
          const emailId = form.querySelector('#emailId')?.value;
          if (emailId) {
            emailActions.loadReplies(emailId);
          }
        } else {
          alert(data.message || 'Failed to send');
        }
      })
      .catch(error => console.error('Error submitting form:', error));
  }
};
  
  // Search Functionality
  const search = {
    searchEmails(query) {
      const lowercaseQuery = query.toLowerCase().trim();
  
      if (!lowercaseQuery) {
        state.currentPage = 1;
        const startIndex = (state.currentPage - 1) * state.emailsPerPage;
        const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
        emailActions.renderEmails(emailsToRender);
        return;
      }
  
      const filteredEmails = state.emails.filter(email => {
        const sender = (email.username || email.sender).toLowerCase();
        const subject = email.subject.toLowerCase();
        const body = email.body.toLowerCase();
        return sender.includes(lowercaseQuery) || subject.includes(lowercaseQuery) || body.includes(lowercaseQuery);
      });
  
      state.emailList.innerHTML = filteredEmails.length ? filteredEmails.map(email => `
        <div class="card email-card" data-email-id="${email.id}" data-read="${email.read}" data-starred="${email.starred}" data-archived="${email.archived}">
          <div class="card-body d-flex align-items-start">
            <img src="${email.sender_profile_image || '/static/images/default_profile.png'}" alt="User" class="profile-img" onerror="this.src='/static/images/default_profile.png'" />
            <div class="ms-3 flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${email.username || email.sender}</h6>
                <span class="time">${utils.formatTime(email.timestamp)}</span>
              </div>
              <p class="text-muted mb-1">
                <strong>${email.subject}</strong>
                ${!email.read && email.sender !== '{{ user.email }}' ? '<span class="badge bg-success ms-2">New</span>' : ''}
                ${email.starred ? '<i class="ri-star-line starred ms-2"></i>' : ''}
              </p>
              <p class="email-preview">${email.body.substring(0, 50)}${email.body.length > 50 ? '...' : ''}</p>
            </div>
            <div class="dropdown">
              <button class="btn btn-light more-options" data-bs-toggle="dropdown"><i class="ri-more-2-line"></i></button>
              <ul class="dropdown-menu">
                ${email.archived ? 
                  `<li><a class="dropdown-item archive-action" href="#" data-email-id="${email.id}" data-action="unarchive"><i class="ri-inbox-unarchive-line"></i> Unarchive</a></li>` : 
                  `<li><a class="dropdown-item archive-action" href="#" data-email-id="${email.id}" data-action="archive"><i class="ri-archive-line"></i> Archive</a></li>`}
                <li><a class="dropdown-item star-action" href="#" data-email-id="${email.id}"><i class="ri-star-line"></i> ${email.starred ? 'Unstar' : 'Star'}</a></li>
                <li><a class="dropdown-item delete-action" href="#" data-email-id="${email.id}"><i class="ri-delete-bin-line"></i> Delete</a></li>
              </ul>
            </div>
          </div>
        </div>
      `).join('') : '<p class="text-muted text-center mt-3">No emails found</p>';
  
      emailActions.attachEmailCardListeners();
  
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      loadMoreContainer.innerHTML = ''; // Hide Load More button during search
  
      if (!filteredEmails.length) {
        state.emailContentSection.innerHTML = '<p>No emails selected</p>';
        state.repliesContainer.innerHTML = '';
      }
    }
  };
  
  // Initialization
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    state.emailList = document.getElementById('emailList');
    state.emailContentSection = document.querySelector('.email-content-section');
    state.repliesContainer = document.getElementById('repliesContainer');
  
    const elements = {
      composeBtn: document.getElementById('composeBtn'),
      composeContainer: document.getElementById('composeContainer'),
      closeCompose: document.getElementById('closeCompose'),
      discardCompose: document.getElementById('discardCompose'),
      composeForm: document.getElementById('composeForm'),
      composeAttachment: document.getElementById('composeAttachment'),
      composePreview: document.getElementById('composeAttachmentPreview'),
      composeSizeInfo: document.getElementById('composeAttachmentSizeInfo'),
      replyContainer: document.getElementById('replyContainer'),
      closeReply: document.getElementById('closeReply'),
      discardReply: document.getElementById('discardReply'),
      replyForm: document.getElementById('replyForm'),
      replyAttachment: document.getElementById('replyAttachment'),
      replyPreview: document.getElementById('replyAttachmentPreview'),
      replySizeInfo: document.getElementById('replyAttachmentSizeInfo'),
      allMailsTab: document.getElementById('allMailsTab'),
      sentTab: document.getElementById('sentTab'),
      archiveTab: document.getElementById('archiveTab'),
      starredTab: document.getElementById('starredTab'),
      unreadTab: document.getElementById('unreadTab'),
      searchInput: document.getElementById('searchInput'),
      searchButton: document.getElementById('searchButton')
    };
  
    // Initial Load
    emailActions.loadEmails(state.currentFilter);
  
    // Event Listeners
    elements.composeBtn.addEventListener('click', () => elements.composeContainer.classList.add('active'));
    elements.closeCompose.addEventListener('click', () => elements.composeContainer.classList.remove('active'));
    elements.discardCompose.addEventListener('click', () => 
      compose.resetForm(elements.composeContainer, elements.composeForm, elements.composePreview, elements.composeAttachment, elements.composeSizeInfo, compose.composeFiles));
    elements.closeReply.addEventListener('click', () => elements.replyContainer.classList.remove('active'));
    elements.discardReply.addEventListener('click', () => 
      compose.resetForm(elements.replyContainer, elements.replyForm, elements.replyPreview, elements.replyAttachment, elements.replySizeInfo, compose.replyFiles));
  
    elements.composeAttachment.addEventListener('change', () => 
      compose.updateAttachmentPreview(elements.composeAttachment, elements.composePreview, elements.composeSizeInfo, compose.composeFiles));
    elements.replyAttachment.addEventListener('change', () => 
      compose.updateAttachmentPreview(elements.replyAttachment, elements.replyPreview, elements.replySizeInfo, compose.replyFiles));
  
    elements.composeForm.addEventListener('submit', (e) => {
      e.preventDefault();
      compose.submitForm(elements.composeForm, elements.composeContainer, elements.composePreview, elements.composeAttachment, elements.composeSizeInfo, 
        () => {
          state.currentPage = 1; // Reset pagination
          emailActions.loadEmails(state.currentFilter);
        }, compose.composeFiles);
    });
  
    elements.replyForm.addEventListener('submit', (e) => {
      e.preventDefault();
      compose.submitForm(elements.replyForm, elements.replyContainer, elements.replyPreview, elements.replyAttachment, elements.replySizeInfo, 
        () => emailActions.loadEmail(document.getElementById('emailId').value), compose.replyFiles);
    });
  
    const switchTab = (filter) => {
      [elements.allMailsTab, elements.sentTab, elements.archiveTab].forEach(tab => tab.classList.remove('active'));
      const tabMap = { 'all': elements.allMailsTab, 'sent': elements.sentTab, 'archive': elements.archiveTab };
      if (tabMap[filter]) tabMap[filter].classList.add('active');
      state.currentFilter = filter;
      state.currentPage = 1; // Reset pagination when switching tabs
      emailActions.loadEmails(filter);
    };
  
    const closeDropdown = () => {
      const dropdown = document.querySelector('.options-dropdown .btn');
      const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
      if (bsDropdown) bsDropdown.hide();
    };
  
    elements.allMailsTab.addEventListener('click', (e) => { e.preventDefault(); switchTab('all'); });
    elements.sentTab.addEventListener('click', (e) => { e.preventDefault(); switchTab('sent'); });
    elements.archiveTab.addEventListener('click', (e) => { e.preventDefault(); switchTab('archive'); });
    elements.starredTab.addEventListener('click', (e) => { e.preventDefault(); switchTab('starred'); closeDropdown(); });
    elements.unreadTab.addEventListener('click', (e) => { e.preventDefault(); switchTab('unread'); closeDropdown(); });
  
    const debouncedSearch = utils.debounce(() => search.searchEmails(elements.searchInput.value), 300);
    elements.searchInput.addEventListener('input', (e) => {
      debouncedSearch();
      if (e.inputType === 'deleteContentBackward' && !elements.searchInput.value.trim()) {
        state.currentPage = 1;
        const startIndex = (state.currentPage - 1) * state.emailsPerPage;
        const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
        emailActions.renderEmails(emailsToRender);
      }
    });
    elements.searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') search.searchEmails(elements.searchInput.value);
      if (e.key === 'Backspace' && !elements.searchInput.value.trim()) {
        state.currentPage = 1;
        const startIndex = (state.currentPage - 1) * state.emailsPerPage;
        const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
        emailActions.renderEmails(emailsToRender);
      }
    });
    elements.searchButton.addEventListener('click', (e) => {
      e.preventDefault();
      search.searchEmails(elements.searchInput.value);
    });
    elements.searchInput.addEventListener('change', () => {
      if (!elements.searchInput.value.trim()) {
        state.currentPage = 1;
        const startIndex = (state.currentPage - 1) * state.emailsPerPage;
        const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
        emailActions.renderEmails(emailsToRender);
      }
    });
    elements.searchInput.addEventListener('search', () => {
      if (!elements.searchInput.value) {
        state.currentPage = 1;
        const startIndex = (state.currentPage - 1) * state.emailsPerPage;
        const emailsToRender = state.emails.slice(startIndex, startIndex + state.emailsPerPage);
        emailActions.renderEmails(emailsToRender);
      }
    });
  });
</script>
{% endblock %}